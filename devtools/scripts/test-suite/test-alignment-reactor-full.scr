;;;; TEST-ALIGNMENT-REACTOR-FULL.SCR ;;;;
; Purpose: Full automated test of alignment reactor behavior
; Tests: Insert Sta bubble, stretch leader (should update), stretch alignment (should update)
(load (strcat (getvar "dwgprefix") "cnm-test-validation.lsp"))
(if (findfile (strcat (getvar "dwgprefix") "haws-debug-log.md")) (vl-file-delete (strcat (getvar "dwgprefix") "haws-debug-log.md")))
(haws-setvar "DebugLevel" "1")
(princ "\n========== STARTING ALIGNMENT REACTOR TEST ==========")
; Insert Sta bubble
(princ "\n--- Step 1: Insert Sta bubble ---")
mspace
haws-elll
10140,20280
10135,20270
1
.
sta
10360,20240

(princ "\n--- Step 2: Validate reactor attached ---")
(setq test-bubble (entlast))
(setq test-result (test-validate-reactor test-bubble "NOTETXT1" "Sta" "Initial insertion"))
(if test-result
  (princ "\n[PASS] Reactor attached correctly")
  (princ "\n[FAIL] Reactor not attached correctly - ABORTING")
)
; Stretch leader (should work)
(princ "\n\n--- Step 3: Stretch leader ---")
(princ "\n(This should update the bubble text)")
_stretch
_crossing
10139,20279
10141,20281

0,0.01

(princ "\n--- Step 4: Check bubble text after leader stretch ---")
(setq lattribs-after-leader (hcnm-bn-dwg-to-lattribs test-bubble))
(setq text-after-leader (cadr (assoc "NOTETXT1" lattribs-after-leader)))
(princ (strcat "\nBubble text: " text-after-leader))
(if (vl-string-search "STA" text-after-leader)
  (princ "\n[PASS] Leader stretch updated bubble")
  (princ "\n[FAIL] Leader stretch did NOT update bubble")
)
; Stretch alignment (should work but currently fails)
(princ "\n\n--- Step 5: Stretch alignment ---")
(princ "\n(This SHOULD update the bubble text but may fail)")
_stretch
_crossing
10039,20239
10341,20241

0,0.01

(princ "\n--- Step 6: Check bubble text after alignment stretch ---")
(setq lattribs-after-align (hcnm-bn-dwg-to-lattribs test-bubble))
(setq text-after-align (cadr (assoc "NOTETXT1" lattribs-after-align)))
(princ (strcat "\nBubble text: " text-after-align))
(if (and (vl-string-search "STA" text-after-align)
         (/= text-after-align text-after-leader))
  (princ "\n[PASS] Alignment stretch updated bubble")
  (princ "\n[FAIL] Alignment stretch did NOT update bubble")
)
(princ "\n\n========== TEST COMPLETE - Check debug log ==========")
